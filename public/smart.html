<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ã‚²ã‚­ãƒˆãƒ„ï¼ãƒ¬ãƒ¼ã‚·ãƒ³ã‚° ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼</title>

    <script src="/socket.io/socket.io.js"></script>

    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        h1 { color: #333; margin-bottom: 5px; }
        .stage-box {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            margin-top: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .data-display {
            background-color: #fff;
            text-align: left;
        }
        .data-display strong { display: inline-block; width: 100px; }
        
        /* è¨±å¯ã‚¨ãƒªã‚¢ (æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—) */
        #permission-area {
            background-color: #ffe0b2;
        }
        #permission-btn {
            padding: 12px 25px;
            font-size: 16px;
            background-color: #ff9800;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 3px #c47600;
        }
        
        /* ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚¨ãƒªã‚¢ (æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—) */
        #mode-select-area {
            background-color: #e0f7fa;
        }
        .mode-select-btn {
            padding: 12px 25px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            background-color: #2196F3;
            color: white;
            box-shadow: 0 4px #0d47a1;
        }
        
        .status-ok { color: green; font-weight: bold; }
        .status-ng { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ã‚²ã‚­ãƒˆãƒ„ï¼ãƒ¬ãƒ¼ã‚·ãƒ³ã‚°</h1>
    <p>ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ãƒ‡ãƒã‚¤ã‚¹ID: <span id="myid">æ¥ç¶šä¸­...</span></p>

    <!-- 1. ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ã‚¨ãƒªã‚¢ -->
    <div id="permission-area" class="stage-box">
        <h2>ã‚¹ãƒ†ãƒƒãƒ— 1: ã‚»ãƒ³ã‚µãƒ¼è¨±å¯</h2>
        <p>iOS 13ä»¥é™ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã¯ã€å‚¾ãã¨åŠ é€Ÿåº¦ã®åˆ©ç”¨è¨±å¯ãŒå¿…è¦ã§ã™ã€‚</p>
        <button id="permission-btn" onclick="requestPermission()">ã‚»ãƒ³ã‚µãƒ¼ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
    </div>
    
    <!-- 2. ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚¨ãƒªã‚¢ -->
    <div id="mode-select-area" class="stage-box" style="display:none;">
        <h2>ã‚¹ãƒ†ãƒƒãƒ— 2: ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ</h2>
        <p>PCç”»é¢ã§è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
        <button class="mode-select-btn" data-mode="single">ğŸš— ã‚·ãƒ³ã‚°ãƒ«ãƒ—ãƒ¬ã‚¤</button>
        <button class="mode-select-btn" data-mode="multi">ğŸ’¥ å¯¾æˆ¦ãƒ¬ãƒ¼ã‚¹</button>
    </div>

    <!-- 3. ãƒ—ãƒ¬ã‚¤ä¸­ã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="data-area" class="stage-box data-display" style="display:none;">
        <h2>æ“ä½œä¸­</h2>
        <p>æ¥ç¶šçŠ¶æ…‹: <span id="status">åˆ‡æ–­</span></p>
        <p><strong>å‚¾ã Î² (å·¦å³)</strong>: <span id="beta-data">0</span> Â°</p>
        <p><strong>å‚¾ã Î³ (å‰å¾Œ)</strong>: <span id="gamma-data">0</span> Â°</p>
        <p><strong>åŠ é€Ÿåº¦ Z</strong>: <span id="accelz-data">0</span> (ã‚²ã‚­ãƒˆãƒ„åŠ›)</p>
    </div>

    <script>
        // --- å¤‰æ•°ã¨å®šæ•° ---
        let socket;
        let myid;
        const ROOM_NAME = "game";
        const UPDATE_INTERVAL = 50; // 50msã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ (1ç§’é–“ã«20å›)
        
        let currentMode = null; // é¸æŠã•ã‚ŒãŸãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰
        let currentBeta = 0;
        let currentGamma = 0;
        let currentAccelZ = 0;
        
        // --- åˆæœŸåŒ–å‡¦ç† ---
        function initController() {
            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã®å–å¾—ã¨è¨­å®š
            myid = sessionStorage.getItem('clientId');
            if (!myid) {
                myid = Math.random().toString(36).substring(2, 15);
                sessionStorage.setItem('clientId', myid);
            }
            document.getElementById("myid").innerText = myid;

            // Socket.ioæ¥ç¶š
            socket = io.connect({ query: { clientId: myid } });

            socket.on('connect', () => {
                document.getElementById('status').innerHTML = '<span class="status-ok">æ¥ç¶šæ¸ˆã¿</span>';
            });

            socket.on('disconnect', () => {
                document.getElementById('status').innerHTML = '<span class="status-ng">åˆ‡æ–­</span>';
            });
            
            // ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            document.querySelectorAll('#mode-select-area .mode-select-btn').forEach(button => {
                button.onclick = (e) => {
                    currentMode = e.target.dataset.mode;
                    if (socket && socket.connected) {
                        // ã‚µãƒ¼ãƒãƒ¼ã¸ROOMåã¨é¸æŠãƒ¢ãƒ¼ãƒ‰ã‚’é€ä¿¡ ('join_game'ã‚¤ãƒ™ãƒ³ãƒˆ)
                        socket.emit("join_game", { room: ROOM_NAME, mode: currentMode });
                        
                        // UIã‚’ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
                        document.getElementById('mode-select-area').style.display = 'none';
                        document.getElementById('data-area').style.display = 'block';
                        
                        // ã‚»ãƒ³ã‚µãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
                        window.addEventListener('deviceorientation', handleOrientation, true);
                        window.addEventListener('devicemotion', handleMotion, true);

                        // å®šæœŸçš„ãªãƒ‡ãƒ¼ã‚¿é€ä¿¡ã‚’é–‹å§‹
                        setInterval(sendSensorData, UPDATE_INTERVAL);
                        
                    } else {
                        alert('ã‚µãƒ¼ãƒãƒ¼ã¨æœªæ¥ç¶šã§ã™ã€‚PCå´ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    }
                };
            });
            
            // è¨±å¯å®Œäº†å¾Œã€ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã‚’è¡¨ç¤º
            document.getElementById('permission-area').style.display = 'none';
            document.getElementById('mode-select-area').style.display = 'block';
        }

        // --- ã‚»ãƒ³ã‚µãƒ¼å‡¦ç† (deviceorientation: å‚¾ã) ---
        function handleOrientation(event) {
            currentBeta = event.beta; 
            currentGamma = event.gamma; 
            
            document.getElementById('beta-data').innerText = currentBeta.toFixed(2);
            document.getElementById('gamma-data').innerText = currentGamma.toFixed(2);
        }

        // --- ã‚»ãƒ³ã‚µãƒ¼å‡¦ç† (devicemotion: åŠ é€Ÿåº¦) ---
        function handleMotion(event) {
            // Zè»¸æ–¹å‘ã®åŠ é€Ÿåº¦ï¼ˆä¸Šä¸‹ã®æŒ¯ã‚Šï¼‰
            currentAccelZ = event.acceleration.z || 0; 

            document.getElementById('accelz-data').innerText = currentAccelZ.toFixed(2);
        }

        // --- ãƒ‡ãƒ¼ã‚¿é€ä¿¡ ---
        function sendSensorData() {
            if (socket && socket.connected && currentMode) {
                const data = {
                    id: myid,
                    room: ROOM_NAME,
                    b: currentBeta.toFixed(2),  // å·¦å³ç§»å‹•ç”¨
                    g: currentGamma.toFixed(2), // å‰å¾Œç”¨
                    // ã‚²ã‚­ãƒˆãƒ„åŠ›ãƒãƒ£ãƒ¼ã‚¸åˆ¤å®šç”¨ã«åŠ é€Ÿåº¦Zè»¸ã®çµ¶å¯¾å€¤ã‚’é€ä¿¡
                    accelerationZ: Math.abs(currentAccelZ).toFixed(2)
                };
                
                // 'sensor'ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
                socket.emit('sensor', data); 
            }
        }

        // --- iOS 13+ ã‚»ãƒ³ã‚µãƒ¼è¨±å¯é–¢æ•° ---
        function requestPermission() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            document.getElementById('permission-area').innerHTML = '<p class="status-ok">ã‚»ãƒ³ã‚µãƒ¼åˆ©ç”¨ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸã€‚</p>';
                            initController(); // è¨±å¯å¾Œã€ãƒ¢ãƒ¼ãƒ‰é¸æŠã«é€²ã‚€
                        } else {
                            document.getElementById('permission-area').innerHTML = '<p class="status-ng">ã‚»ãƒ³ã‚µãƒ¼åˆ©ç”¨ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚</p>';
                        }
                    })
                    .catch(e => {
                        document.getElementById('permission-area').innerHTML = `<p class="status-ng">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}</p>`;
                    });
            } else {
                // è¨±å¯ãŒä¸è¦ãªç’°å¢ƒ (Android, PCãªã©)
                document.getElementById('permission-area').innerHTML = '<p class="status-ok">ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ã¯ä¸è¦ã§ã™ã€‚</p>';
                initController(); // ãã®ã¾ã¾ãƒ¢ãƒ¼ãƒ‰é¸æŠã«é€²ã‚€
            }
        }
    </script>
</body>
</html>
