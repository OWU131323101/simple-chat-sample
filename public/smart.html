<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ゲキトツ！レーシング コントローラー</title>

    <script src="/socket.io/socket.io.js"></script>

    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        h1 { color: #333; margin-bottom: 5px; }
        .stage-box {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            margin-top: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .data-display {
            background-color: #fff;
            text-align: left;
        }
        .data-display strong { display: inline-block; width: 100px; }
        
        /* 許可エリア (最初のステップ) */
        #permission-area {
            background-color: #ffe0b2;
        }
        #permission-btn {
            padding: 12px 25px;
            font-size: 16px;
            background-color: #ff9800;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 3px #c47600;
        }
        
        /* モード選択エリア (次のステップ) */
        #mode-select-area {
            background-color: #e0f7fa;
        }
        .mode-select-btn {
            padding: 12px 25px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            background-color: #2196F3;
            color: white;
            box-shadow: 0 4px #0d47a1;
        }
        
        .status-ok { color: green; font-weight: bold; }
        .status-ng { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ゲキトツ！レーシング</h1>
    <p>コントローラーデバイスID: <span id="myid">接続中...</span></p>

    <!-- 1. センサー許可エリア -->
    <div id="permission-area" class="stage-box">
        <h2>ステップ 1: センサー許可</h2>
        <p>iOS 13以降のデバイスでは、傾きと加速度の利用許可が必要です。</p>
        <button id="permission-btn" onclick="requestPermission()">センサーを有効にする</button>
    </div>
    
    <!-- 2. モード選択エリア -->
    <div id="mode-select-area" class="stage-box" style="display:none;">
        <h2>ステップ 2: プレイモードを選択</h2>
        <p>PC画面で表示されているモードを選択してください。</p>
        <button class="mode-select-btn" data-mode="single">🚗 シングルプレイ</button>
        <button class="mode-select-btn" data-mode="multi">💥 対戦レース</button>
    </div>

    <!-- 3. プレイ中のデータ表示エリア -->
    <div id="data-area" class="stage-box data-display" style="display:none;">
        <h2>操作中</h2>
        <p>接続状態: <span id="status">切断</span></p>
        <p><strong>傾き β (左右)</strong>: <span id="beta-data">0</span> °</p>
        <p><strong>傾き γ (前後)</strong>: <span id="gamma-data">0</span> °</p>
        <p><strong>加速度 Z</strong>: <span id="accelz-data">0</span> (ゲキトツ力)</p>
    </div>

    <script>
        // --- 変数と定数 ---
        let socket;
        let myid;
        const ROOM_NAME = "game";
        const UPDATE_INTERVAL = 50; // 50msごとにデータを送信 (1秒間に20回)
        
        let currentMode = null; // 選択されたプレイモード
        let currentBeta = 0;
        let currentGamma = 0;
        let currentAccelZ = 0;
        
        // --- 初期化処理 ---
        function initController() {
            // クライアントIDの取得と設定
            myid = sessionStorage.getItem('clientId');
            if (!myid) {
                myid = Math.random().toString(36).substring(2, 15);
                sessionStorage.setItem('clientId', myid);
            }
            document.getElementById("myid").innerText = myid;

            // Socket.io接続
            socket = io.connect({ query: { clientId: myid } });

            socket.on('connect', () => {
                document.getElementById('status').innerHTML = '<span class="status-ok">接続済み</span>';
            });

            socket.on('disconnect', () => {
                document.getElementById('status').innerHTML = '<span class="status-ng">切断</span>';
            });
            
            // モード選択ボタンのイベントリスナーを設定
            document.querySelectorAll('#mode-select-area .mode-select-btn').forEach(button => {
                button.onclick = (e) => {
                    currentMode = e.target.dataset.mode;
                    if (socket && socket.connected) {
                        // サーバーへROOM名と選択モードを送信 ('join_game'イベント)
                        socket.emit("join_game", { room: ROOM_NAME, mode: currentMode });
                        
                        // UIをプレイモードに切り替え
                        document.getElementById('mode-select-area').style.display = 'none';
                        document.getElementById('data-area').style.display = 'block';
                        
                        // センサーイベントリスナーの設定
                        window.addEventListener('deviceorientation', handleOrientation, true);
                        window.addEventListener('devicemotion', handleMotion, true);

                        // 定期的なデータ送信を開始
                        setInterval(sendSensorData, UPDATE_INTERVAL);
                        
                    } else {
                        alert('サーバーと未接続です。PC側が起動しているか確認してください。');
                    }
                };
            });
            
            // 許可完了後、モード選択画面を表示
            document.getElementById('permission-area').style.display = 'none';
            document.getElementById('mode-select-area').style.display = 'block';
        }

        // --- センサー処理 (deviceorientation: 傾き) ---
        function handleOrientation(event) {
            currentBeta = event.beta; 
            currentGamma = event.gamma; 
            
            document.getElementById('beta-data').innerText = currentBeta.toFixed(2);
            document.getElementById('gamma-data').innerText = currentGamma.toFixed(2);
        }

        // --- センサー処理 (devicemotion: 加速度) ---
        function handleMotion(event) {
            // Z軸方向の加速度（上下の振り）
            currentAccelZ = event.acceleration.z || 0; 

            document.getElementById('accelz-data').innerText = currentAccelZ.toFixed(2);
        }

        // --- データ送信 ---
        function sendSensorData() {
            if (socket && socket.connected && currentMode) {
                const data = {
                    id: myid,
                    room: ROOM_NAME,
                    b: currentBeta.toFixed(2),  // 左右移動用
                    g: currentGamma.toFixed(2), // 前後用
                    // ゲキトツ力チャージ判定用に加速度Z軸の絶対値を送信
                    accelerationZ: Math.abs(currentAccelZ).toFixed(2)
                };
                
                // 'sensor'イベントでサーバーに送信
                socket.emit('sensor', data); 
            }
        }

        // --- iOS 13+ センサー許可関数 ---
        function requestPermission() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            document.getElementById('permission-area').innerHTML = '<p class="status-ok">センサー利用が許可されました。</p>';
                            initController(); // 許可後、モード選択に進む
                        } else {
                            document.getElementById('permission-area').innerHTML = '<p class="status-ng">センサー利用が拒否されました。</p>';
                        }
                    })
                    .catch(e => {
                        document.getElementById('permission-area').innerHTML = `<p class="status-ng">エラーが発生しました: ${e.message}</p>`;
                    });
            } else {
                // 許可が不要な環境 (Android, PCなど)
                document.getElementById('permission-area').innerHTML = '<p class="status-ok">センサー許可は不要です。</p>';
                initController(); // そのままモード選択に進む
            }
        }
    </script>
</body>
</html>
