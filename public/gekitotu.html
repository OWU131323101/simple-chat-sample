<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚²ã‚­ãƒˆãƒ„ï¼ãƒ¬ãƒ¼ã‚·ãƒ³ã‚° (PCç”»é¢)</title>
    
    <!-- p5.js ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/addons/p5.sound.min.js"></script>
    
    <!-- Socket.io ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
    <script src="/socket.io/socket.io.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; color: #fff; }
        /* ç”»é¢ä¸Šéƒ¨ã«UIã‚’é‡ã­ã¦è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #ui-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            font-family: Arial, sans-serif;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            width: 280px;
            max-height: 95vh; /* ç¸¦é•·ç”»é¢å¯¾å¿œ */
            overflow-y: auto;
        }
        .status-item { margin-bottom: 5px; }
        .player-info { 
            border-bottom: 1px solid #333; 
            padding-bottom: 5px; 
            margin-bottom: 5px; 
            /* ã‚´ãƒ¼ãƒ«æ¸ˆã¿ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯è‰²ã‚’å¤‰ãˆã‚‹ */
            transition: all 0.3s;
        }
        .finished { background-color: rgba(0, 255, 0, 0.1); }
        
        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®èª¿æ•´ */
        #start-screen {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.9); 
            z-index: 20; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            color: white;
            transition: opacity 0.5s;
        }
        .mode-select-btn {
            padding: 12px 25px;
            margin: 10px;
            font-size: 18px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            background-color: #4CAF50;
            color: white;
            box-shadow: 0 4px #2e8b57;
            transition: background-color 0.2s;
        }
        .mode-select-btn:hover {
            background-color: #388e3c;
        }
    </style>
</head>
<body>
    <div id="ui-overlay">
        <h2>ã‚²ã‚­ãƒˆãƒ„ï¼ãƒ¬ãƒ¼ã‚·ãƒ³ã‚°</h2>
        <p class="status-item">æ¥ç¶šID: <span id="clientIdDisplay">æœªæ¥ç¶š</span></p>
        <hr>
        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆã®è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="game-status">
             <div id="player-list">ãƒ‡ãƒ¼ã‚¿ã‚’å¾…æ©Ÿä¸­...</div>
        </div>
    </div>
    
    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
    <div id="start-screen">
        <h1>GEKITOTSU! RACING</h1>
        <p>ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¨ã—ã¦ä½¿ç”¨ã—ã€ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>
        <button class="mode-select-btn" data-mode="single">ğŸš— ä¸€äººãƒ—ãƒ¬ã‚¤ (éšœå®³ç‰©ã®ã¿)</button>
        <button class="mode-select-btn" data-mode="multi">ğŸ’¥ å¯¾æˆ¦ãƒ¬ãƒ¼ã‚¹ (è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼)</button>
    </div>
    
    <script>
        // --- Socket.io æ¥ç¶šè¨­å®š ---
        let socket;
        let gameData = {
            players: {},
            obstacles: [],
            maxLap: 2
        };
        let currentClientId = "Unknown"; // è‡ªèº«ã®ID
        let gameStarted = false;         // ã‚²ãƒ¼ãƒ ãŒé–‹å§‹ã•ã‚Œã¦ã„ã‚‹ã‹
        
        // ã‚µãƒ¼ãƒãƒ¼å´ã®å®šæ•°ã‚’å‚ç…§
        const TRACK_WIDTH_X = 250;
        const COURSE_LENGTH_Z = 1000;

        // p5.jsã®åˆæœŸåŒ–æ™‚ã«å‘¼ã°ã‚Œã‚‹
        function setupSocket() {
            socket = io.connect(); 

            socket.on('connect', () => {
                currentClientId = socket.id;
                document.getElementById('clientIdDisplay').innerText = currentClientId;
                console.log('Socket connected: ' + currentClientId);
            });

            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡
            socket.on('game state', (data) => {
                gameData = data;
                updateUI(); // UIã‚’æ›´æ–°
            });

            socket.on('user joined', (newPlayer) => {
                console.log(newPlayer.id + 'ãŒå‚åŠ ã—ã¾ã—ãŸã€‚');
            });
            
            socket.on('user left', (clientId) => {
                console.log(clientId + 'ãŒåˆ‡æ–­ã—ã¾ã—ãŸã€‚');
                delete gameData.players[clientId];
            });
        }
        
        // ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        document.querySelectorAll('.mode-select-btn').forEach(button => {
            button.onclick = (e) => {
                const mode = e.target.dataset.mode;
                if (socket && socket.connected) {
                    // ã‚µãƒ¼ãƒãƒ¼ã¸ROOMã¨é¸æŠãƒ¢ãƒ¼ãƒ‰ã‚’é€ä¿¡ (join_gameã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ç”¨)
                    socket.emit("join_game", { room: "game", mode: mode });
                    
                    // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã‚’éè¡¨ç¤ºã«ã—ã€ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                    document.getElementById('start-screen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('start-screen').style.display = 'none';
                        gameStarted = true;
                    }, 500);
                    
                } else {
                    alert('Socketã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼ˆã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ï¼‰ã¨PCãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
            };
        });

        // --- p5.js 3Dæç”»è¨­å®š ---
        
        function setup() {
            createCanvas(windowWidth, windowHeight, WEBGL);
            angleMode(DEGREES);
            setupSocket();
        }

        function draw() {
            // ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã¯æç”»ã—ãªã„
            if (!gameStarted) {
                background(0);
                return;
            }

            // --- ç’°å¢ƒå…‰ã®å¼·åŒ– (æ˜ã‚‹ã•èª¿æ•´) ---
            background(50, 50, 80); // èƒŒæ™¯è‰²ï¼ˆå¤œç©ºã®ã‚ˆã†ãªé’ï¼‰
            ambientLight(150); // å…¨ä½“ã‚’æ˜ã‚‹ãã™ã‚‹åŸºæœ¬å…‰ (éå¸¸ã«é‡è¦)
            pointLight(255, 255, 255, 0, -200, 0); // ä¸­å¤®ä¸Šéƒ¨ã‹ã‚‰ã®ç™½ç†±ç¯
            directionalLight(200, 200, 200, 0.5, -1, 0.5); // æ–œã‚ã‹ã‚‰ã®å…‰

            // ã‚«ãƒ¡ãƒ©è¨­å®š
            let myPlayer = gameData.players[currentClientId];
            
            if (myPlayer) {
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å°‘ã—å¾Œã‚ã‹ã‚‰è¦‹ä¸‹ã‚ã™è¦–ç‚¹ã«ã‚«ãƒ¡ãƒ©ã‚’å›ºå®šï¼ˆä¸‰äººç§°è¦–ç‚¹ï¼‰
                camera(
                    myPlayer.x,             // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼Xåº§æ¨™
                    -200,                   // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼Yåº§æ¨™ (ç©ºã‹ã‚‰è¦‹ä¸‹ã‚ã™é«˜ã•)
                    myPlayer.z + 200,       // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼Zåº§æ¨™ (å°‘ã—å¾Œã‚)
                    myPlayer.x,             // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆX (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¦‹ã‚‹)
                    0,                      // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆY
                    myPlayer.z,             // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆZ
                    0, 1, 0
                );
            } else {
                 // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯å›ºå®šè¦–ç‚¹
                 camera(0, -300, 300, 0, 0, 0, 0, 1, 0);
            }
            
            // --- ã‚³ãƒ¼ã‚¹ã®æç”» ---
            push();
            fill(0, 150, 0); // ã‚³ãƒ¼ã‚¹ã®è‰²
            
            // ã‚³ãƒ¼ã‚¹ã®å¹³é¢ã‚’æç”» (å¹…: TRACK_WIDTH_X * 2, é•·ã•: COURSE_LENGTH_Z * 2 * MAX_LAP)
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®Zåº§æ¨™ã«åˆã‚ã›ã¦ã‚³ãƒ¼ã‚¹ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹
            let courseDepth = COURSE_LENGTH_Z * gameData.maxLap * 2;
            translate(0, 0, myPlayer ? myPlayer.z + courseDepth / 2 : 0);
            plane(TRACK_WIDTH_X * 2, courseDepth + 100); 
            pop();
            
            // --- Z=0 ã®ã‚¹ã‚¿ãƒ¼ãƒˆ/ãƒ©ãƒƒãƒ—ãƒ©ã‚¤ãƒ³ã‚’æç”» ---
            push();
            stroke(255);
            strokeWeight(5);
            line(-TRACK_WIDTH_X, 1, 0, TRACK_WIDTH_X, 1, 0);
            noStroke();
            pop();


            // --- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æç”» ---
            for (const id in gameData.players) {
                const player = gameData.players[id];
                
                // ã‚·ãƒ³ã‚°ãƒ«ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰ã§ã€è‡ªåˆ†ä»¥å¤–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æç”»ã—ãªã„ï¼ˆãŠåŒ–ã‘ã‚´ãƒ¼ã‚¹ãƒˆã¯é™¤ãï¼‰
                if (gameData.players[currentClientId] && 
                    gameData.players[currentClientId].mode === 'single' && 
                    id !== currentClientId) {
                    continue;
                }

                push();
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½ç½®ã¸ç§»å‹•
                translate(player.x, 0, player.z); 

                // ã‚²ã‚­ãƒˆãƒ„åŠ›ã«å¿œã˜ã¦è‰²ã‚’å¤‰ãˆã‚‹
                let colorIntensity = map(player.gekitotsuForce, 0, gameData.maxGekitotsuForce || 10, 100, 255, true);
                
                if (id === currentClientId) {
                    // è‡ªåˆ†ã®è»Šã¯æ˜ã‚‹ã„èµ¤
                    ambientMaterial(255, colorIntensity, colorIntensity); 
                } else {
                    // ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è»Šã¯é’
                    ambientMaterial(colorIntensity, colorIntensity, 255);
                }
                
                // è»Šã‚’è¡¨ã™ç®±ã‚’æç”»
                box(30, 10, 50); 
                
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼IDã‚’è¡¨ç¤º (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¸Šã«æµ®ã‹ã›ã‚‹)
                fill(255);
                textSize(12);
                textAlign(CENTER);
                text(id, 0, -25, 0); 
                
                pop();
            }

            // --- éšœå®³ç‰©ã®æç”» ---
            gameData.obstacles.forEach(obs => {
                // è¡çªã—ã¦ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹éšœå®³ç‰©ã¯æç”»ã—ãªã„
                if (obs.collided) return; 

                push();
                // éšœå®³ç‰©ã®æç”»ä½ç½®ã¯Zåº§æ¨™ã®ç¯„å›²ã«æ³¨æ„
                translate(obs.x, 0, obs.z);
                
                if (obs.type === 'box') {
                    ambientMaterial(200, 100, 0); // ç®±ã¯èŒ¶è‰²
                    box(obs.size, obs.size, obs.size);
                } else if (obs.type === 'bonus') {
                    ambientMaterial(255, 255, 0); // ãƒœãƒ¼ãƒŠã‚¹ã¯é»„è‰²
                    sphere(obs.size); // ãƒœãƒ¼ãƒŠã‚¹ã®ã‚µã‚¤ã‚ºã‚’é©ç”¨
                }
                pop();
            });
        }
        
        function windowResized() {
            resizeCanvas(windowWidth, windowHeight);
        }

        // --- UIæ›´æ–°é–¢æ•° ---
        function updateUI() {
            const playerListDiv = document.getElementById('player-list');
            playerListDiv.innerHTML = ''; 

            let playersArray = Object.values(gameData.players)
                                    .filter(p => p.mode === gameData.players[currentClientId]?.mode && p.status !== 'lobby');
            
            // Zåº§æ¨™ã«åŸºã¥ã„ã¦æš«å®šçš„ã«é †ä½ä»˜ã‘
            playersArray.sort((a, b) => {
                if (a.status === 'finished' && b.status !== 'finished') return -1;
                if (a.status !== 'finished' && b.status === 'finished') return 1;
                if (a.status === 'finished' && b.status === 'finished') return a.finishTime - b.finishTime; 
                
                if (a.lap !== b.lap) return b.lap - a.lap;
                return a.z - b.z; 
            });

            playersArray.forEach((player, index) => {
                const isMe = player.id === currentClientId;
                const element = document.createElement('div');
                element.className = 'player-info' + (player.status === 'finished' ? ' finished' : '');
                
                let rankDisplay = `#${index + 1}`;
                if (player.status === 'finished') {
                    rankDisplay = `ğŸ ${index + 1}ä½ (T:${((player.finishTime - player.startTime) / 1000).toFixed(1)}s)`;
                }

                element.innerHTML = `
                    <p style="color: ${isMe ? '#00e600' : '#fff'}; font-weight: bold;">
                        ${rankDisplay} ${isMe ? 'ã€è‡ªåˆ†ã€‘' : ''} ${player.id}
                    </p>
                    <p>ãƒã‚¤ãƒ³ãƒˆ: ${player.points} / ã‚²ã‚­ãƒˆãƒ„åŠ›: ${player.gekitotsuForce.toFixed(0)}</p>
                    <p>é€Ÿåº¦: ${player.speed.toFixed(1)} / ãƒ©ãƒƒãƒ—: ${player.lap} / ${gameData.maxLap}</p>
                `;
                playerListDiv.appendChild(element);
            });
        }
        
        // --- ç‹¬è‡ªã®ãƒ­ã‚¸ãƒƒã‚¯ã¨ã—ã¦ã€startTimeã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã«æ¥ç¶šæ™‚ã«è¨­å®š ---
        // ã‚µãƒ¼ãƒãƒ¼å´ã§finishTimeãŒè¨­å®šã•ã‚ŒãŸãŸã‚ã€startTimeã‚‚å¿…è¦
        socket.on('join_game', (data) => {
             // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚åˆ»ã‚’è¨˜éŒ²
            gameData.players[currentClientId].startTime = Date.now();
        });

    </script>
</body>
</html>
